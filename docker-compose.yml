version: "3.1"

# bash into container docker exec -it user sh

services:
  #typesense:
  #  container_name: typesense
  #  entrypoint: sh -c "/opt/typesense-server --data-dir /data --api-key=local-typesense-api-key --enable-cors"
  #  restart: on-failure
  #  ports:
  #    - "8108:8108"
  #  volumes:
  #    - ./data/typesense:/data

  kratos-migrate:
    container_name: kratos-migrate
    image: oryd/kratos:v0.9.0-alpha.3
    environment:
      - DSN=mysql://root:rootPassword@tcp(mysql:3306)/mysql?max_conns=20&max_idle_conns=4
    volumes:
      - type: bind
        source: ./services/kratos
        target: /etc/config/kratos
    command: -c /etc/config/kratos/kratos.yml migrate sql -e --yes
    restart: on-failure

  kratos-selfservice-ui-node:
    container_name: kratos-ui
    image: oryd/kratos-selfservice-ui-node:v0.9.0-alpha.3
    ports:
      - "4455:4455"
    environment:
      - PORT=4455
      - SECURITY_MODE=
      - KRATOS_BROWSER_URL=http://127.0.0.1:4433/

  kratos:
    container_name: kratos
    depends_on:
      - kratos-migrate
    image: oryd/kratos:v0.9.0-alpha.3
    ports:
      - '4433:4433' # public
      - '4434:4434' # admin
    restart: on-failure
    volumes:
      - type: bind
        source: ./services/kratos
        target: /etc/config/kratos
    environment:
      - DSN=mysql://root:rootPassword@tcp(mysql:3306)/mysql?max_conns=20&max_idle_conns=4
      - LOG_LEVEL=trace
    command: serve -c /etc/config/kratos/kratos.yml --dev --watch-courier

  mailslurper:
    container_name: mailslurper
    image: oryd/mailslurper:latest-smtps
    ports:
      - '4436:4436'
      - '4437:4437'

  scylla:
    container_name: scylla
    image: scylladb/scylla:latest
    command: --smp 2 --memory 750M --overprovisioned 1 --api-address 0.0.0.0
    ports:
      - "9042:9042"
    volumes:
      - ./_data/scylla1:/var/lib/scylla/data

  mysql:
    image: mysql
    container_name: mysql
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 3306:3306
    volumes:
      - ./_data/mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootPassword

  nats:
    image: nats
    container_name: nats
    expose:
      - "4222"
    ports:
      - "8222:8222"
      - "4222:4222"
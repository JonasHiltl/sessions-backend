version: "3.1"

# bash into container docker exec -it user sh

services:
  #typesense:
  #  container_name: typesense
  #  entrypoint: sh -c "/opt/typesense-server --data-dir /data --api-key=local-typesense-api-key --enable-cors"
  #  restart: on-failure
  #  ports:
  #    - "8108:8108"
  #  volumes:
  #    - ./data/typesense:/data

  scylla:
    container_name: scylla
    image: scylladb/scylla:latest
    command: --smp 1 --api-address 0.0.0.0
    ports:
      - "9042:9042"
    volumes:
      - ./_data/scylla1:/var/lib/scylla/data

  mysql:
    image: mysql
    container_name: mysql
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 3306:3306
    volumes:
      - ./_data/mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootPassword

  nats:
    image: nats
    container_name: nats
    expose:
      - "4222"
    ports:
      - "8222:8222"
      - "4222:4222"
  envoy:
    image: envoyproxy/envoy:v1.20-latest
    container_name: envoy
    ports:
      - 8000:8000
      - 8001:8001
    depends_on:
      - user
      - party
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml
      - ./packages/grpc/comment/comment_descriptor.pb:/tmp/envoy/comment_descriptor.pb
      - ./packages/grpc/common/common_descriptor.pb:/tmp/envoy/common_descriptor.pb
      - ./packages/grpc/party/party_descriptor.pb:/tmp/envoy/party_descriptor.pb
      - ./packages/grpc/story/story_descriptor.pb:/tmp/envoy/story_descriptor.pb
      - ./packages/grpc/user/user_descriptor.pb:/tmp/envoy/user_descriptor.pb
    command:
      - -l debug
      - -c /etc/envoy/envoy.yaml
